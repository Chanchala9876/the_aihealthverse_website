<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat - HealthVerse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2>Real-Time Chat</h2>
    <div id="chat-box" class="border rounded p-3 mb-3 bg-light" style="height: 350px; overflow-y: scroll;"></div>
    <form id="chat-form" class="d-flex" autocomplete="off">
        <input type="text" id="message" class="form-control me-2" placeholder="Type your message..." required aria-label="Message" />
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
</div>
<script>
    var chatId = /*[[${chatId}]]*/ 'demo-chat';
    var sender = /*[[${sender}]]*/ 'user';
    var recipient = /*[[${recipient}]]*/ 'doctor';
    var doctorName = /*[[${doctorName}]]*/ 'Doctor';
    
    // Debug log to check values
    console.log('Chat initialized:', { chatId, sender, recipient, doctorName, path: window.location.pathname });
    
    // Ensure recipient is set to AI for AI chat - check both URL and recipient value
    if (window.location.pathname.includes('/ai-chat') || recipient === 'ai@healthverse.com') {
        recipient = 'ai@healthverse.com';
        doctorName = 'HealthVerse AI';
        console.log('AI chat mode activated');
    }
    var stompClient = null;
    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/topic/messages', function (messageOutput) {
                var msg = JSON.parse(messageOutput.body);
                if (msg.chatId === chatId) {
                    showMessage(msg);
                }
            });
        });
    }
    function showMessage(msg) {
        var chatBox = document.getElementById('chat-box');
        var isUser = msg.sender === sender;
        var isAI = msg.sender === 'ai@healthverse.com';
        var senderLabel = isUser ? 'You' : (isAI ? 'AI' : (msg.sender === recipient ? doctorName : msg.sender));
        var time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        var msgClass = isUser ? 'text-end' : 'text-start';
        var bubbleClass = isUser ? 'bg-primary text-white' : (isAI ? 'bg-success text-white' : 'bg-secondary text-white');
        chatBox.innerHTML += `<div class="mb-2 ${msgClass}">
            <span class="small fw-bold">${senderLabel}</span>
            <div class="d-inline-block px-3 py-2 rounded ${bubbleClass}" style="max-width: 70%; word-break: break-word;">
                ${msg.content}
            </div>
            <span class="small text-muted ms-2">${time}</span>
        </div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    // Fetch chat history on page load
    function fetchChatHistory() {
        fetch('/api/chat/history/' + chatId)
            .then(response => response.json())
            .then(messages => {
                var chatBox = document.getElementById('chat-box');
                chatBox.innerHTML = '';
                messages.forEach(function(msg) {
                    showMessage(msg);
                });
            });
    }
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var content = document.getElementById('message').value;
        var message = {
            chatId: chatId, 
            sender: sender, 
            recipient: recipient, 
            content: content,
            senderType: 'patient'
        };
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
        document.getElementById('message').value = '';
    });
    fetchChatHistory();
    connect();
</script>
</body>
</html> 